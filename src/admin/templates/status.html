{% extends "template_base.html" %}

{% block title %}Bot Status{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-activity"></i> Bot Health & Metrics</h4>
                <small class="text-muted">Last updated: {{ last_updated|default('Just now') }}</small>
            </div>
            <div class="card-body">
                <!-- Overall Health Status -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="mb-2">
                                    {% if overall_health == 'healthy' %}
                                        <i class="bi bi-circle-fill text-success display-4"></i>
                                    {% elif overall_health == 'warning' %}
                                        <i class="bi bi-circle-fill text-warning display-4"></i>
                                    {% else %}
                                        <i class="bi bi-circle-fill text-danger display-4"></i>
                                    {% endif %}
                                </div>
                                <h5 class="card-title mb-0">Overall Health</h5>
                                <p class="card-text"><span class="badge bg-{{ 'success' if overall_health|default('unknown') == 'healthy' else 'warning' if overall_health == 'warning' else 'danger' }}">
                                    {{ overall_health|default('unknown')|title }}
                                </span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h3 class="text-primary">{{ queue_length|default(0) }}</h3>
                                <h6>Queue Length</h6>
                                <small class="text-muted">Pending jobs</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h3 class="text-info">{{ active_workers|default(0) }}</h3>
                                <h6>Active Workers</h6>
                                <small class="text-muted">Processing images</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h3 class="text-success">{{ uptime|default('0s') }}</h3>
                                <h6>Uptime</h6>
                                <small class="text-muted">Bot running time</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Queue Metrics -->
                <h5 class="mt-4 mb-3"><i class="bi bi-bar-chart"></i> Queue Status</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Queue Usage</h6>
                                <div class="progress">
                                    {% set queue_percentage = (queue_length|default(0) / queue_depth|default(100)) * 100 %}
                                    <div class="progress-bar {{ 'bg-danger' if queue_percentage > 90 else 'bg-warning' if queue_percentage > 75 else 'bg-success' }}"
                                         role="progressbar" style="width: {{ queue_percentage }}%"
                                         aria-valuenow="{{ queue_percentage }}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <small class="text-muted">{{ queue_length|default(0) }}/{{ queue_depth|default(100) }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Worker Load</h6>
                                <div class="progress">
                                    {% set worker_percentage = (active_workers|default(0) / worker_threads|default(2)) * 100 %}
                                    <div class="progress-bar {{ 'bg-danger' if worker_percentage > 90 else 'bg-warning' if worker_percentage > 75 else 'bg-success' }}"
                                         role="progressbar" style="width: {{ worker_percentage }}%"
                                         aria-valuenow="{{ worker_percentage }}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <small class="text-muted">{{ active_workers|default(0) }}/{{ worker_threads|default(2) }} active</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Service Status -->
                <h5 class="mt-4 mb-3"><i class="bi bi-gear"></i> Service Health</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-discord text-info"></i> Discord Connection
                                </div>
                                <span class="badge bg-success">Connected</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-api text-primary"></i> OpenRouter API
                                </div>
                                <span class="badge bg-{{ 'success' if openrouter_status|default('unknown') == 'healthy' else 'warning' if openrouter_status == 'warning' else 'danger' }}">
                                    {{ openrouter_status|default('unkown')|title }}
                                </span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-database text-warning"></i> Database
                                </div>
                                <span class="badge bg-success">Healthy</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                Memory Usage
                                <small>{{ memory_usage|default('0 MB') }}</small>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                Cache Size
                                <small>{{ cache_size|default('0 MB') }}</small>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                Recent Errors
                                <span class="badge bg-danger">{{ recent_errors_count|default(0) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Errors -->
                {% if recent_errors %}
                <h5 class="mt-4 mb-3"><i class="bi bi-exclamation-triangle"></i> Recent Errors</h5>
                <div class="accordion" id="errorsAccordion">
                    {% for error in recent_errors %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="error{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                                <strong>{{ error.timestamp|default('Unknown') }}</strong> - {{ error.type|default('Error') }}
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="error{{ loop.index }}" data-bs-parent="#errorsAccordion">
                            <div class="accordion-body">
                                <pre class="bg-light p-2 rounded"><code>{{ error.message|default('No details') }}</code></pre>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-success mt-4" role="alert">
                    <i class="bi bi-check-circle"></i> No recent errors detected.
                </div>
                {% endif %}

                <!-- Performance Metrics Placeholder -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Performance Trends</h6>
                                <small class="text-muted">Detailed performance analytics coming soon.</small>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}